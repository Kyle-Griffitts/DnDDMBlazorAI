@page "/"  
@rendermode InteractiveServer  
@using Azure.AI.OpenAI  
@using Azure.Identity  
@using OpenAI.Chat  
@inject Microsoft.Extensions.Configuration.IConfiguration _config  
@inject DungeonMasterChatService DungeonMasterChat  

<div class="page-scroll">

    <h2 class="glow-text text-center">📜 Dungeon Master's Oracle</h2>

    <div class="input-group mb-3" style="max-width: 800px; width: 100%;">
        <input class="form-control" @bind="userMessage" @onkeydown="HandleEnter" placeholder =" Speak your spell..." />
        <button class="btn glow-button" @onclick="SendMessage">Cast</button>
    </div>

    <div class="chat-container card p-3">
        @foreach (var message in DungeonMasterChat.GetChatLog())
        {
            var isLast = message == DungeonMasterChat.GetChatLog().Last();
            <div class="chat-bubble @(message.Role == "user" ? "user-msg" : "bot-msg") mb-2">
                <div class="chat-meta text-muted">
                    <strong>@message.Role:</strong>
                </div>
                <div class="chat-content">@message.Content</div>
            </div>
        }
    </div>

</div>

@code {  
    private string? userMessage;  

    private async Task SendMessage()  
    {  
        if (string.IsNullOrWhiteSpace(userMessage)) return;  

        await DungeonMasterChat.SendMessageAsync(userMessage);  
        userMessage = string.Empty;  
        StateHasChanged();  
    }  

    private async void HandleEnter(KeyboardEventArgs e)  
    {  
        if (e.Key == "Enter")  
        {  
            await SendMessage();  
        }  
    }  
}
